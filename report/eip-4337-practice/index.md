# EIP-4337 与智能钱包的可能性：实现视角

（最后修订时间：2022-11-25）

## 执行摘要

以太坊区块链关于账户抽象的 EIP-4337 提案，是当前智能合约钱包热潮中的焦点。

让用户在链上自行管理资产，是区块链技术给互联网带来的一个主要变化，这是所谓「可拥有」的 Web3.0 的最大承诺。但目前，对于用户来说，依赖于助记词、私钥的链上账户有着极高的使用门槛。对开发者来说，当前的账户本身没有可编程性。

EIP-4337 的「钱包合约账户」可能改变这种状态，并成为众多 Web3.0 应用的提供给用户自行保管资产的主要方式。在这里，我们基于提案技术规格和项目组的官方代码实现，来探讨它带来的机遇及如何开发。

EIP-4337 所提供的方案是，让区块链用户可以用「合约账户」作为主账户，用它保管链上资产，并用它直接在链上发起交易事务。本文称这个合约为「钱包合约」，也对应地称用户使用的账户为「钱包合约账户」。对以太坊来说，让「合约账户」能直接发起交易事务（而无需 EOA 外部账户)，即实现所谓所谓账户抽象（Account Abstraction，AA）是一个巨大的变化。

EIP-4337 是用一系列新的组件来达成这一目标的：

- 它为用户发起链上交易规定了一个新的结构体（「用户操作 UserOperation」），
- 它为用于钱包账户功能的合约（「钱包合约」「钱包合约账户」）提出了标准的接口，
- 它提供了链上（「入口点合约」）与链下的组件（「打包者」与「用户操作内存池」）。

这一 EIP 提案无需对以太坊协议进行变更，其亦为 ERC 系列的提案，可在 L2、侧链、EVM 兼容链上实现。另外，其他支持智能合约的、非 EVM 兼容链也可以参照实现。

简要地说，EIP-4337 带来了如下三个新特性：

1. **提出了用智能合约实现用户的「钱包合约账户」的标准化方案**。

2. **提供了实现账户抽象（即用户无需 「EOA 外部账户」、仅需「合约账户」）的可行路径**。

3. **提供了标准化的 Gas 费（燃料费）的代付方式，即代付者（Paymaster）机制**。

这一提案将为降低用户使用区块链账户、自托管自身资产降低门槛，同时为应用开发者开发新钱包功能提供了极大的自由度。

在 EIP-4337 之前，用户高度依赖 EOA 外部账户：我们用它保管资产，用它发起交易，且发起交易时账户中需要有 ETH 以支付燃料费。

在 EIP-4337 之后，我们可用「合约账户」保管资产、发起交易，且可由其他人代付燃料费。

遵循 EIP-4337 提供的「钱包合约账户」的技术规范，开发者可以方便地开发钱包合约/钱包软件、支持多种多样的账户功能，以及在以太坊中支持更多的签名算法与机制。

关于 EIP-4337 已经有不少的讨论文章，而本文将主要聚焦于与技术实践相关的两个话题：

- 第一，EIP-4337 是如何解决它所界定的问题的，即它的原理、架构与组件是什么？
- 第二，如果一个应用要遵循 EIP-4337 为用户提供应用内钱包，如何进行开发？

对第一个问题的讨论，应能帮助所有感兴趣的人深入地理解 EIP-4337 及它可能带来的变化。而应用开发者可通过对第二个问题的讨论快速地入手、实际进行开发。

重要说明：在多数情况下，我们将用户使用的用于保管私钥、进行签名的软件称为钱包（Wallet)，而将链上的、用户保存资产的实体称为账户(Account)。这也是 EIP-4337 项目组在代码实现中最新采纳的命名规则。当前，项目组官方代码正在进行快速迭代(如 [AA-61 Commit](https://github.com/eth-infinitism/account-abstraction/commit/695e490484dbf380b9135d30b57037a0428514aa))，本文中代码的 `Wallet` 与 `Acccount` 恰好处在更新迭代期，并未完全统一。

## 总目录

---

    目录

    0. 一个使用场景
      - EIP-4337 带来的六个变化
      - EIP-4337 相关术语表

    1. 为什么需要 EIP-4337
      1.1. 以太坊账户：EOA 外部账户与合约账户
      1.2. 当前实践中的以太坊账户改进
        - 1.2.1. 现有改进之一：多签钱包
        - 1.2.2. 现有改进之二：无需燃料费的元交易

    2. EIP-4337 的三种场景
      2.1. 场景一：用户的「钱包合约账户」自付燃料费
      2.2. 场景二：由代付者（Paymaster）支付燃料费
      2.3. 场景三：使用聚合签名

    3. EIP-4337 的原理与组件
      3.1 运行 EIP-4337：通过运行理解
        - 3.1.1. 准备工作：合约部署与运行打包者
        - 3.1.2. 创建账户：首次操作钱包
        - 3.1.3. 资产转账：转账 ETH 与 ERC20 Token
        - 3.1.4. 代付机制：代付者支付燃料费

      3.2 EIP-4337 的组件详解
        - 3.2.1.  `UserOperation`
        - 3.2.2. 入口点合约 EntryPoint
        - 3.2.3. 打包者、打包者网络与 UO Mempool

    4. 应用与钱包开发者的视角
      4.1. 钱包应用的两项关键任务
      4.2. 钱包合约与部署者合约
      4.3. 链外签名与链上签名验证
      4.4. 代付者合约

    5. 总结与展望

说明：EIP-4337 引入一组全新的组件：用户操作(UserOperation)、打包者(Bundler)、入口点合约(EntryPoint Contract)、钱包合约(Wallet Contract)、 UO 内存池(UO Mempool)。同时，要深入理解 EIP-4337 需要对以太坊原有的相应组件如 EOA 外部账户与合约账户、交易事务（Transaction, tx）、Create2合约部署方式等有较为详尽的了解。在这里，我们将在涉及时一一讨论。相关的术语的中英文对照可参考文中「[EIP-4337 相关术语表](glossary)」。
